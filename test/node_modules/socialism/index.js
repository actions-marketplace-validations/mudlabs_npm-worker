#!/usr/bin/env node
if (process.mainModule === module)
  setImmediate(() =>
    main(process.argv).catch(e => console.log(e.stack) && process.exit(1))
  );

const fs = require("fs");
const parser = require("csv-parser");
const concat = require("concat-stream");
const random = require("random-item");
const wrap = require("wordwrap");
const path = require("path");

function getQuoteStream() {
  return fs
    .createReadStream(path.resolve(__dirname, "quotes.csv"))
    .pipe(parser());
}

async function getQuote() {
  const quotes = await new Promise((resolve, reject) => {
    getQuoteStream().pipe(concat(resolve));
  });
  return random(quotes);
}

async function main(argv) {
  const quote = await getQuote();

  if (argv[2] === "will" && argv[3] === "win") {
    console.log("Revolutionary consciousness, comrade");
    return;
  }

  if (argv.some(arg => arg === "--json")) {
    console.log(JSON.stringify(quote));
    return;
  }

  console.log(
    wrap(8, 70)(`${quote.quote}
  -- ${quote.attribution}`)
  );
}

module.exports = getQuote;
